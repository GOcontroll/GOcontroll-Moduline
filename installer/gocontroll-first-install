#!/bin/bash

# url to bash this script:
# wget -O - https://raw.githubusercontent.com/Rick-GO/GOcontroll-Moduline/master/installer/gocontroll-first-install | bash -s master

YELLOW='\033[33m'
NORMAL='\033[0m'

echo -e "${YELLOW}stop Node-RED service ${NORMAL}"
systemctl stop nodered.service 

echo -e "${YELLOW}stop Simulink service ${NORMAL}"
systemctl stop simulink

# starting with updating the repositories
echo -e "${YELLOW} Update repositories before we do a system update ${NORMAL}"
apt-get update

# Jump to root folder
cd 

# check if the GOcontroll folder on root already exists. If existing, delete
if [ -d GOcontroll ]
then
echo -e "${YELLOW} Delete existing GOcontroll folder ${NORMAL}"
	rm -r GOcontroll
fi

# Create ne empty GOcontroll folder
echo -e "${YELLOW} Create new GOcontroll folder ${NORMAL}"
mkdir GOcontroll

# Jump to GOcontroll folder
cd GOcontroll
ls

# Check if git is already installed on the system
if ! [ -x "$(command -v git)" ]; then
echo -e "${YELLOW} Git is not yet installed so let's install first ${NORMAL}"
apt-get -y install git 
fi

# Download the GOcontroll Moduline GIT repository:
echo -e "${YELLOW} Download files for GOcontroll Moduline ${NORMAL}"
git clone https://github.com/Rick-GO/GOcontroll-Moduline.git --branch $1

echo -e "${YELLOW}Reload systemd daemon ${NORMAL}"
systemctl daemon-reload

echo -e "${YELLOW}Copy specific files to Platform ${NORMAL}"

## Store the new folders/files
cp -avr /root/GOcontroll/GOcontroll-Moduline/lib /
cp -avr /root/GOcontroll/GOcontroll-Moduline/etc /
cp -avr /root/GOcontroll/GOcontroll-Moduline/usr /
cp -avr /root/GOcontroll/GOcontroll-Moduline/root /

## Assign executable rights to file
chmod 755 /usr/scripts/simulink.sh
chmod 755 /usr/scripts/simcom-start.sh
chmod 755 /usr/local/bin/qmi-network-raw
chmod 755 /usr/moduline/simcom-start.hex
chmod 755 /usr/moduline/simcom-stop.hex


# Make resolv.conf immutable
chattr +i /etc/resolv.conf


# check if the mem-sim folder exists, if so, delete
if [ -d /usr/mem-sim ]
then
echo -e "${YELLOW} Delete existing mem-sim folder ${NORMAL}"
	rm -r /usr/mem-sim
fi

# Create folder to store all shared values in
mkdir /usr/mem-sim

echo -e "${YELLOW}Activate modules for wifi ${NORMAL}"
depmod

echo -e "${YELLOW}Activate Services for wifi ${NORMAL}"
service hostapd start
service dnsmasq start

echo -e "${YELLOW}Reboot controller ${NORMAL}"
reboot

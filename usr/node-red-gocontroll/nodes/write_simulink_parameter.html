<script type="text/javascript">
    RED.nodes.registerType('Write-Simulink-Parameter', {
        category: 'GOcontroll',
        color: '#f76d11',
        defaults: {
            name: {value:""},
            sampleTime: {value:"1000"},
            Signal: {value:""},
            KeyOut: {value:""},
            keyIn: {value:""},
            data: {value:""},
        },
        inputs:1,
        outputs:1,
        icon: "arrow-in.png",
        paletteLabel: "Simulink Parameter",
        label: function() {
            if(this.name != ""){
                return this.name;
            }
            if(this.SignalKey == ""){
                return this.SignalKey;
            } else {
                return "Select a Parameter to write to";
            }
        },

        oneditprepare: function() {
            fetch('parameters.json')
            .then((Response) => {
                if (!Response.ok) {
                    throw new Error('HTTP error: ' + Response.status);
                }
                return Response.json();
            })
            .then((json) => {initialize(json);
            })
            .catch((err) => console.error('Fetch problem: ' + err.message));
        },
    });

    function initialize(json) {
        keys = Object.keys(json);
        var selectKey = document.getElementById("node-input-Signal");
        for ( var i = 0; i< keys.length; i++) {
            var option = keys[i];
            var el = document.createElement("option");
            el.textContent = option;
            el.value = option;
            selectKey.appendChild(el);
        }
    }

</script>>

<script type="text/x-red" data-template-name="Write-Simulink-Parameter" id="Write-Simulink-Parameter-Configuration">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="node-input-Signal"><i class="fa fa-id-card"></i> Simulink signal</label>
        <select id="node-input-Signal" style="width:300px"> 
            <option value>Choose a parameter</option>
        </select>
    </div>

    <div class="form-row"> 
        <label for="node-input-KeyOut"><i class="fa fa-id-card"></i> Input key</label>
        <input type="text" id="node-input-KeyIn">
    </div>

    <div class="form-row"> 
        <label for="node-input-KeyOut"><i class="fa fa-id-card"></i> Output key</label>
        <input type="text" id="node-input-KeyOut">
    </div>
	
	<div class="form-row">
        <label for="node-input-sampleTime"><i class="fa fa-repeat"></i> Sample time</label>
        <select id="node-input-sampleTime" style="width:300px" title="The sample time sets the period on which the signals are retrieved">
            <option value="1000">1 s</option>
            <option value="200">200 ms</option>
            <option value="100">100 ms</option>
			<option value="50">50 ms</option>
        </select>
    </div>
<div id="read-simulink-settings"></div>
</script>

<script type="text/x-red" data-help-name="Write-Simulink-Parameter">
    <p>The Write Simulink Parameter block is used to overwrite the value of a globally exported parameter in simulink. Select the desired parameter and sample time. It will output its current value at the interval of the sample time, and overwrite the value when it receives a signal on the input.</p>
    <h2>Configuration</h2>
    <p><strong><em>Simulink signal:</em></strong></p>
    <p>Select the desired Simulink parameter.</p>
    <p><strong><em>Sample time:</em></strong></p>
    <p>Specify the sample time at which to read the Simulink parameter.</p>
    <h2><strong>Data format</strong></h2>
    <p>The data coming from the Node is pushed out of the node in a JSON string format holding 1 key and 1 values. The key can be customized to descriptive output signal names. This improves the readability from signals in the model.</p>
    <p>&nbsp;</p>
    <h2><strong>Example</strong></h2>
    <p>This example shows the output data from a write simulink parameter node during operation:</p>
    <p>{"Output key" : 2766 }</p>
    <p>or in case the parameter is an array</p>
    <p>{"Output key" : [100, 65, 300]}</p> 
    <p>&nbsp;</p>
    <p>Input example:</p>
    <p>{"Input Key" : 800}</p>
    <p>or in case the parameter is an array</p>
    <p>{"Input Key" : [300, 400, 500]}</p>
</script>
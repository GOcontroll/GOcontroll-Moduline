<script type="text/javascript">
    RED.nodes.registerType('Write-Simulink-Parameter', {
        category: 'GOcontroll',
        color: '#f76d11',
        defaults: {
            name: {value:""},
            sampleTime: {value:"1000"},
            parameter: {value:""},
            keyIn: {value:""},
            data: {value:""},
        },
        inputs:1,
        outputs:1,
        icon: "arrow-in.png",
        paletteLabel: "Simulink Parameter",
        label: function() {
            if(this.name != ""){
                return this.name;
            } else {
                return "Write to Simulink";
            }
        },

        oneditprepare: function() {
            var node = this;
            fetch('parameters.json')
            .then((Response) => {
                if (!Response.ok) {
                    throw new Error('HTTP error: ' + Response.status);
                }
                return Response.json();
            })
            .then((json) => {
                var keys = Object.keys(json);
                var options = $('#node-input-parameter').typedInput({type:"Parameter", types:[{
                    value: "Parameter",
                    options: getOptions(keys)
                }]})
                options.typedInput('value',node.parameter);
                var keyin = $('#node-input-keyIn').typedInput({type:'str', types: ["str"]})
                keyin.typedInput('value', node.keyIn);
            })
            .catch((err) => {console.error('Fetch problem: ' + err.message);
            node.status({fill:"red", shape:"dot", text:"An error occured fetching parameters.json"});
            });
        },
        oneditsave: function() {
            this.parameter = $('#node-input-parameter').typedInput("value")  
            this.keyIn = $('#node-input-keyIn').typedInput("value")
        },
    });

    function getOptions(keys) {
        var result = []
        for (const key in keys) {
            result.push({value: keys[key], label: keys[key]})
        }
        return result;
    }
</script>>

<script type="text/x-red" data-template-name="Write-Simulink-Parameter" id="Write-Simulink-Parameter-Configuration">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="node-input-sampleTime"><i class="fa fa-repeat"></i> Sample time</label>
        <select id="node-input-sampleTime" style="width:300px" title="The sample time sets the period on which the signals are retrieved">
            <option value="1000">1 s</option>
            <option value="200">200 ms</option>
            <option value="100">100 ms</option>
			<option value="50">50 ms</option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-parameter"><i class="icon-tag"></i> Parameter</label>
        <input type="text" id="node-input-parameter">
    </div>

    <div class="form-row"> 
        <label for="node-input-keyIn"><i class="fa fa-id-card"></i> Input key</label>
        <input type="text" id="node-input-keyIn">
    </div>
	
	
<div id="read-simulink-settings"></div>
</script>

<script type="text/x-red" data-help-name="Write-Simulink-Parameter">
    <p>The Write Simulink Parameter block is used to overwrite the value of a globally exported parameter in simulink. Select the desired parameter and sample time. It will output its current value at the interval of the sample time, and overwrite the value when it receives a signal on the input.</p>
    <h2>Configuration</h2>
    <p><strong><em>Simulink signal:</em></strong></p>
    <p>Select the desired Simulink parameter.</p>
    <p><strong><em>Sample time:</em></strong></p>
    <p>Specify the sample time at which to read the Simulink parameter.</p>
    <h2><strong>Data format</strong></h2>
    <p>The data coming from the Node is pushed out of the node in a JSON string format holding 1 key and 1 values. The key is the same as the selected parameter name.</p>
    <p>&nbsp;</p>
    <h2><strong>Example</strong></h2>
    <p>This example shows the output data from a write simulink parameter node during operation:</p>
    <p>{"Parameter name" : 2766 }</p>
    <p>or in case the parameter is an array</p>
    <p>{"Parameter name" : [100, 65, 300]}</p> 
    <p>&nbsp;</p>
    <p>Input example:</p>
    <p>{"Input Key" : 800}</p>
    <p>or in case the parameter is an array</p>
    <p>{"Input Key" : [300, 400, 500]}</p>
</script>